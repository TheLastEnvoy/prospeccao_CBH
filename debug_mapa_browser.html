<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Mapa - Coronel Domingo Soares</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Debug do Mapa - Coronel Domingo Soares</h1>
    
    <div class="debug-section info">
        <h3>üìä Informa√ß√µes do Teste</h3>
        <p><strong>Munic√≠pio IPEA:</strong> "Coronel Domingos Soares" (36 OSCs)</p>
        <p><strong>Munic√≠pio GeoJSON:</strong> "CORONEL DOMINGO SOARES"</p>
        <p><strong>Objetivo:</strong> Verificar se o mapeamento est√° funcionando</p>
    </div>

    <button onclick="testarAPI()">1. Testar API /municipios-data/</button>
    <button onclick="testarMapeamento()">2. Testar Mapeamento</button>
    <button onclick="testarBusca()">3. Testar Busca por Munic√≠pio</button>
    <button onclick="testarTudo()">4. Testar Tudo</button>

    <div id="resultados"></div>

    <script>
        let oscsData = {};
        let resultadosDiv = document.getElementById('resultados');

        function log(titulo, conteudo, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `debug-section ${tipo}`;
            div.innerHTML = `<h3>${titulo}</h3><pre>${JSON.stringify(conteudo, null, 2)}</pre>`;
            resultadosDiv.appendChild(div);
        }

        function normalizarTexto(texto) {
            if (!texto) return '';
            
            return texto
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^a-z0-9\s]/g, '') // Remove caracteres especiais
                .replace(/\s+/g, ' ') // Normaliza espa√ßos
                .trim();
        }

        function calcularSimilaridade(texto1, texto2) {
            const norm1 = normalizarTexto(texto1);
            const norm2 = normalizarTexto(texto2);
            
            // Igualdade exata ap√≥s normaliza√ß√£o
            if (norm1 === norm2) return 1.0;
            
            // Verificar se um cont√©m o outro
            if (norm1.includes(norm2) || norm2.includes(norm1)) return 0.8;
            
            // Verificar palavras em comum
            const palavras1 = norm1.split(' ').filter(p => p.length > 2);
            const palavras2 = norm2.split(' ').filter(p => p.length > 2);
            
            if (palavras1.length === 0 || palavras2.length === 0) return 0;
            
            const palavrasComuns = palavras1.filter(p => palavras2.includes(p));
            const similaridade = palavrasComuns.length / Math.max(palavras1.length, palavras2.length);
            
            return similaridade;
        }

        async function testarAPI() {
            try {
                log('üîÑ Testando API /municipios-data/', 'Fazendo requisi√ß√£o...');
                
                const response = await fetch('/municipios-data/');
                const data = await response.json();
                
                log('‚úÖ API Response', {
                    status: response.status,
                    total_municipios: data.data.length,
                    primeiro_municipio: data.data[0],
                    coronel_encontrado: data.data.find(m => m.municipio.includes('Coronel'))
                }, 'success');

                // Procurar especificamente por Coronel Domingos Soares
                const coronelDomingos = data.data.find(m => m.municipio === 'Coronel Domingos Soares');
                
                if (coronelDomingos) {
                    log('üéØ Coronel Domingos Soares Encontrado', coronelDomingos, 'success');
                } else {
                    log('‚ùå Coronel Domingos Soares N√ÉO Encontrado', 'Munic√≠pio n√£o est√° na API', 'error');
                }

                return data;
            } catch (error) {
                log('‚ùå Erro na API', error.message, 'error');
            }
        }

        async function testarMapeamento() {
            try {
                const data = await fetch('/municipios-data/').then(r => r.json());
                
                // Simular o processamento do mapa
                oscsData = {};
                
                data.data.forEach(item => {
                    const municipio = item.municipio;
                    const count = item.total_oscs;

                    function armazenarVariacao(variacao) {
                        if (variacao && !oscsData[variacao]) {
                            oscsData[variacao] = count;
                        }
                    }

                    // Nome original
                    armazenarVariacao(municipio);

                    // Mapeamentos espec√≠ficos
                    const mapeamentosEspecificos = {
                        'Coronel Domingos Soares': [
                            'CORONEL DOMINGO SOARES',
                            'Coronel Domingo Soares',
                            'coronel domingo soares'
                        ]
                    };

                    if (mapeamentosEspecificos[municipio]) {
                        mapeamentosEspecificos[municipio].forEach(armazenarVariacao);
                    }
                });

                // Verificar se o mapeamento funcionou
                const variacoes = [
                    'Coronel Domingos Soares',
                    'CORONEL DOMINGO SOARES',
                    'Coronel Domingo Soares',
                    'coronel domingo soares'
                ];

                const resultados = {};
                variacoes.forEach(variacao => {
                    resultados[variacao] = oscsData[variacao] || 'N√ÉO ENCONTRADO';
                });

                log('üîÑ Resultado do Mapeamento', resultados, 'info');

                if (oscsData['CORONEL DOMINGO SOARES']) {
                    log('‚úÖ Mapeamento Funcionando', `CORONEL DOMINGO SOARES tem ${oscsData['CORONEL DOMINGO SOARES']} OSCs`, 'success');
                } else {
                    log('‚ùå Mapeamento Falhou', 'CORONEL DOMINGO SOARES n√£o foi mapeado', 'error');
                }

            } catch (error) {
                log('‚ùå Erro no Mapeamento', error.message, 'error');
            }
        }

        function buscarOSCsPorMunicipio(municipio) {
            if (!municipio) return 0;

            // 1. Busca exata
            if (oscsData[municipio] !== undefined) {
                return oscsData[municipio];
            }

            // 2. Busca com normaliza√ß√£o b√°sica
            const municipiosDisponiveis = Object.keys(oscsData);
            
            for (const municipioDisponivel of municipiosDisponiveis) {
                if (municipio.toLowerCase() === municipioDisponivel.toLowerCase()) {
                    return oscsData[municipioDisponivel];
                }
            }

            // 3. Busca por similaridade
            let melhorMatch = null;
            let melhorScore = 0;
            
            for (const municipioDisponivel of municipiosDisponiveis) {
                const score = calcularSimilaridade(municipio, municipioDisponivel);
                
                if (score > melhorScore && score >= 0.6) {
                    melhorScore = score;
                    melhorMatch = municipioDisponivel;
                }
            }
            
            if (melhorMatch) {
                console.log(`‚úÖ Correspond√™ncia encontrada: "${municipio}" -> "${melhorMatch}" (score: ${melhorScore.toFixed(2)})`);
                return oscsData[melhorMatch];
            }

            return 0;
        }

        async function testarBusca() {
            // Primeiro carregar os dados
            await testarMapeamento();

            const testesNomes = [
                'CORONEL DOMINGO SOARES',
                'Coronel Domingo Soares',
                'coronel domingo soares',
                'CORONEL DOMINGOS SOARES',
                'Coronel Domingos Soares'
            ];

            const resultados = {};
            testesNomes.forEach(nome => {
                const oscs = buscarOSCsPorMunicipio(nome);
                resultados[nome] = oscs;
            });

            log('üîç Resultado da Busca', resultados, 'info');

            const coronelDomingoOSCs = buscarOSCsPorMunicipio('CORONEL DOMINGO SOARES');
            if (coronelDomingoOSCs > 0) {
                log('‚úÖ Busca Funcionando', `CORONEL DOMINGO SOARES retorna ${coronelDomingoOSCs} OSCs`, 'success');
            } else {
                log('‚ùå Busca Falhou', 'CORONEL DOMINGO SOARES retorna 0 OSCs', 'error');
            }
        }

        async function testarTudo() {
            resultadosDiv.innerHTML = '';
            
            log('üöÄ Iniciando Teste Completo', 'Testando todas as funcionalidades...');
            
            await testarAPI();
            await testarMapeamento();
            await testarBusca();
            
            log('‚úÖ Teste Completo Finalizado', 'Verifique os resultados acima');
        }
    </script>
</body>
</html>
